allowedPaths:
  - "data/**/meta.json"
  - "data/**/index.md"
  - "data/**/assets/**"
insertTemplate: "/data/${(release_date.match(/\\d{4}/) || [])[0] || ''}/${title.trim().replace(/ +/g, '-').toLowerCase().replace(/[^a-z0-9-]/g, '')}/"
metaSchema:
  $schema: "https://json-schema.org/draft/2020-12/schema"
  title: Movie Metadata
  type: object
  properties:
    title:
      type: string
      description: Exact movie title (no trimming)
    release_date:
      type: string
      pattern: "^\\d{4}-\\d{2}-\\d{2}$"
      description: Release date in YYYY-MM-DD
    genre:
      type: array
      items: { type: string }
      description: List of genres
    url_backdrop:
      type: string
      description: Backdrop image URL (TMDB `backdrop_path` mapped)
    url_poster:
      type: string
      description: Poster image URL (TMDB `poster_path` mapped)
    overview:
      type: string
      description: Short description/overview
    hash_torrent:
      type: array
      description: Torrent hashes with optional descriptions (e.g., quality/size/source)
      items:
        type: object
        properties:
          hash:
            type: string
            description: 40-character BitTorrent info hash (hex)
          description:
            type: string
            description: Human-readable details (e.g., 1080p, BluRay, 2.1 GB)
        required: [ hash ]
    hash_ipfs:
      type: array
      description: IPFS CIDs with optional descriptions
      items:
        type: object
        properties:
          hash:
            type: string
            description: IPFS CID (v0 or v1)
          description:
            type: string
            description: Human-readable details (e.g., source, quality)
        required: [ hash ]
  required: [ title, release_date, genre ]
  additionalProperties: true
db:
  engine: polodb
  # Template-specific: store docs in a "movies" collection
  collection: movies
  # Unique key per branch: Title + Release Year
  unique: [ _branch, title, release_year ]
  indexes:
    - fields: [ title ]
    - fields: [ release_year ]
    - fields: [ genre ]
  # Map DB document fields from meta.json; system fields _branch/_meta_dir/_created_at/_updated_at are injected automatically
  mapping:
    - name: title
      from: $.title
      type: string
    - name: release_date
      from: $.release_date
      type: string
    - name: release_year
      derive:
        fn: year
        args: [ { from: $.release_date, type: string } ]
    - name: genre
      from: $.genre
      type: array[string]
    - name: meta_dir
      from: $meta_dir
      type: string
  queryPolicy:
    fields:
      - { name: title, ops: [ eq, in ] }
      - { name: release_year, ops: [ eq, gte, lte ] }
      - { name: genre, ops: [ contains ] }
    sort:
      - { field: release_date, dir: desc }
      - { field: title, dir: asc }
    pagination:
      defaultPageSize: 25
      maxPageSize: 250
git:
  # Branching / merging / commit strategy rules consumed by relay-hooks.
  # These rules inform what is allowed to be merged/committed and what
  # automated actions should run after certain events.
  # Repo-wide origins/pull permissions (apply to all branches unless overridden)
  allowedOrigins:
    - "https://github.com/clevertree/relay-template/"
  allowPullFrom:
    - "https://github.com/clevertree/relay-template/"
  sources:
    # Named upstream sources that this repo can pull from
    - name: template
      url: https://github.com/clevertree/relay-template/
  branchRules:
    # The default rule applies to any branch not explicitly listed in `branches` below
    default:
      # By default, require signed commits. Any key in .ssh/* is allowed
      requireSigned: true
      allowedKeys:
        - ".ssh/*"
    branches:
      # main branch rules
      - name: main
        rule:
          # Only allow commits that are either:
          #  A) signed by the specific public key in the template repo, or
          #  B) pulled directly from the source origin below
          requireSigned: true
          allowedKeys:
            - ".ssh/id_rsa.pub"
      # public branch rules
      - name: public
        rule:
          # Anyone can modify without a key
          allowUnsigned: true
  autoPush:
    # Branches that should be auto-pushed to all peers after commits/merges
    branches: [ "main", "staging", "develop" ]
    # The peer list is read from this environment variable. The value is a
    # semicolon-separated list of hostnames.
    # Example:
    #   RELAY_MASTER_PEER_LIST=node-dfw1.relaynet.online.online;node2.relaynet.online;node3.relaynet.online
    peersEnv: "RELAY_MASTER_PEER_LIST"
    # Auto-push runs asynchronously and should not block the commit path
    async: true
    # Optional debounce to coalesce rapid successive commits
    debounceSeconds: 2
  hooks:
    github:
      # Enable a webhook endpoint that GitHub can call on pushes
      enabled: true
      # Relative HTTP path that the relay server or hooks docker exposes
      path: "/hooks/github"
      # Name of env var carrying the shared secret set in the GitHub webhook
      secretEnv: "RELAY_GITHUB_WEBHOOK_SECRET"
      # Events we listen to (push is enough to trigger pulls)
      events: [ "push" ]
      # When a push happens on the upstream origin, trigger a pull on these branches
      pullOn:
        origins: [ "https://github.com/clevertree/relay-template/" ]
        branches: [ "*" ]